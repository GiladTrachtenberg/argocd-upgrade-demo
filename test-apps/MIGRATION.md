# Migration from App-of-Apps to ApplicationSet

## Overview

This directory has been migrated from the traditional "App of Apps" pattern to the modern ApplicationSet pattern introduced in Argo CD v2.6.

## What Changed

### Before (App-of-Apps Pattern)
```
test-apps/
├── app-of-apps/application.yaml  # Parent app
├── guestbook/application.yaml    # Child app 1
├── helm-nginx/application.yaml   # Child app 2
├── plain-yaml/application.yaml   # Child app 3
└── kustomization.yaml            # References all files
```

**Issues with this pattern:**
- Required N+1 Application manifests (1 parent + N children)
- Manual maintenance when adding/removing apps
- More complex YAML to manage
- Doesn't scale well beyond 10-20 apps

### After (ApplicationSet Pattern)
```
test-apps/
├── applicationset.yaml           # Single ApplicationSet
├── project.yaml                  # AppProject (unchanged)
└── kustomization.yaml            # References only 2 files
```

**Benefits:**
- Single ApplicationSet generates all Applications
- Automatic discovery of new apps from Git
- Less boilerplate and maintenance
- Native support for progressive sync strategies
- Better scalability (100s of apps)

## How It Works

The ApplicationSet uses a **Git directory generator** that:

1. Scans the `argocd-example-apps` repository
2. Finds all top-level directories (guestbook, helm-guestbook, etc.)
3. Automatically creates an Application for each directory
4. Uses the directory name to construct:
   - Application name: `test-{{directory-name}}`
   - Namespace: `test-{{directory-name}}`
   - Source path: `{{directory-path}}`

## Deployment

### Deploy everything:
```bash
kubectl apply -k test-apps/
```

### Deploy just the ApplicationSet:
```bash
kubectl apply -f test-apps/project.yaml
kubectl apply -f test-apps/applicationset.yaml
```

### View generated Applications:
```bash
# List all Applications generated by the ApplicationSet
kubectl get applications -n argocd -l demo.managed-by=applicationset

# View ApplicationSet status
kubectl get applicationset -n argocd test-apps -o yaml
```

## Migration Steps Performed

1. Created `applicationset.yaml` with Git directory generator
2. Updated `kustomization.yaml` to reference ApplicationSet
3. Deprecated old app-of-apps pattern (`application.yaml.deprecated`)
4. Individual Application manifests moved to legacy (commented in kustomization)

## Rollback (if needed)

To rollback to the app-of-apps pattern:

```bash
# Delete ApplicationSet and generated Applications
kubectl delete applicationset -n argocd test-apps

# Restore old pattern
cd test-apps
mv app-of-apps/application.yaml.deprecated app-of-apps/application.yaml

# Update kustomization.yaml to uncomment individual apps
# Then apply
kubectl apply -k .
```

## Notes

- The ApplicationSet discovers apps from the **Git repository**, not local directories
- Applications are named with `test-` prefix to avoid conflicts
- All generated Applications inherit common sync policies
- Individual app customization can be done via `spec.template` in ApplicationSet

## Further Enhancements

Consider these ApplicationSet features:

1. **List Generator**: Define apps explicitly in ApplicationSet
2. **Cluster Generator**: Deploy same apps to multiple clusters
3. **Matrix Generator**: Combine multiple generators
4. **Progressive Rollouts**: Use rollout strategies for safer deployments
5. **Pull Request Generator**: Auto-deploy PR previews

## References

- [ApplicationSet Documentation](https://argo-cd.readthedocs.io/en/stable/operator-manual/applicationset/)
- [Git Directory Generator](https://argo-cd.readthedocs.io/en/stable/operator-manual/applicationset/Generators-Git/)
- [Migration Guide](https://argo-cd.readthedocs.io/en/stable/operator-manual/applicationset/Appset-Any-Namespace/)
