# Argo CD Test Applications

Modern ApplicationSet-based test application suite for Argo CD upgrade validation.

## Quick Start

### Deploy All Test Applications

```bash
# Deploy the ApplicationSet and project
kubectl apply -k /Users/giladtrachtenberg/work/scripts/argocd/upgrade/test-apps/

# Or deploy individually
kubectl apply -f /Users/giladtrachtenberg/work/scripts/argocd/upgrade/test-apps/project.yaml
kubectl apply -f /Users/giladtrachtenberg/work/scripts/argocd/upgrade/test-apps/applicationset.yaml
```

### View Applications

```bash
# List all Applications generated by ApplicationSet
kubectl get applications -n argocd -l demo.managed-by=applicationset

# View ApplicationSet status
kubectl get applicationset -n argocd test-apps

# Check ApplicationSet details
kubectl describe applicationset -n argocd test-apps

# Watch Application sync status
kubectl get applications -n argocd -w
```

## Architecture

### Current (ApplicationSet Pattern)

```
ApplicationSet (test-apps)
  │
  ├── Discovers: guestbook/
  │   └── Generates: Application (test-guestbook)
  │
  ├── Discovers: helm-guestbook/
  │   └── Generates: Application (test-helm-guestbook)
  │
  └── Discovers: kustomize-guestbook/
      └── Generates: Application (test-kustomize-guestbook)
```

**Key Features:**
- Single ApplicationSet manifest
- Automatic app discovery from Git
- Scales to hundreds of applications
- Progressive rollout capabilities

### Legacy (App-of-Apps Pattern) - DEPRECATED

See `MIGRATION.md` for details on the previous implementation.

## Files

- `applicationset.yaml` - Main ApplicationSet resource (replaces app-of-apps)
- `project.yaml` - AppProject definition for test applications
- `kustomization.yaml` - Kustomize overlay for batch deployment
- `MIGRATION.md` - Detailed migration documentation
- `app-of-apps/application.yaml.deprecated` - Legacy app-of-apps (for reference)

## ApplicationSet Configuration

### Generator: Git Directory

The ApplicationSet uses a Git directory generator to automatically discover applications:

```yaml
generators:
  - git:
      repoURL: https://github.com/argoproj/argocd-example-apps.git
      revision: HEAD
      directories:
        - path: "*"
          exclude: ["apps", ".*"]
```

This discovers all top-level directories except:
- `apps/` - Used by legacy app-of-apps
- Hidden directories (starting with `.`)

### Template

Each discovered directory becomes an Application with:

- **Name**: `test-{{directory-name}}`
- **Namespace**: `test-{{directory-name}}`
- **Source Path**: `{{directory-path}}`
- **Auto-sync**: Enabled with prune and self-heal
- **Project**: `test-apps`

## Testing After Upgrade

### 1. Verify ApplicationSet is Working

```bash
# ApplicationSet should be healthy
kubectl get applicationset -n argocd test-apps

# Should show RUNNING status
kubectl get applicationset -n argocd test-apps -o jsonpath='{.status.conditions[?(@.type=="Ready")].status}'
```

### 2. Check Generated Applications

```bash
# List all generated Applications
kubectl get applications -n argocd -l demo.managed-by=applicationset

# All should show Synced and Healthy
kubectl get applications -n argocd -l demo.managed-by=applicationset -o custom-columns=NAME:.metadata.name,SYNC:.status.sync.status,HEALTH:.status.health.status
```

### 3. Verify Application Resources

```bash
# Check resources in deployed namespaces
kubectl get all -n test-guestbook
kubectl get all -n test-helm-guestbook
kubectl get all -n test-kustomize-guestbook
```

### 4. Test Sync Operations

```bash
# Trigger sync on a specific app
argocd app sync test-guestbook

# Trigger sync on all apps
argocd app sync -l demo.managed-by=applicationset
```

## Troubleshooting

### ApplicationSet Not Creating Applications

```bash
# Check ApplicationSet status and conditions
kubectl describe applicationset -n argocd test-apps

# Check controller logs
kubectl logs -n argocd -l app.kubernetes.io/name=argocd-applicationset-controller
```

### Applications Stuck in OutOfSync

```bash
# Check Application status
kubectl describe application -n argocd test-guestbook

# Force sync
argocd app sync test-guestbook --force
```

### Need to Add New Application

Just add a directory to the Git repository - the ApplicationSet will automatically discover it!

No manifest changes needed.

## Cleanup

### Remove All Applications

```bash
# Delete ApplicationSet (removes all generated Applications)
kubectl delete applicationset -n argocd test-apps

# Delete project
kubectl delete appproject -n argocd test-apps
```

### Remove Specific Application

```bash
# Remove by deleting from Git (ApplicationSet will prune)
# Or manually delete the Application
kubectl delete application -n argocd test-guestbook
```

## Advanced Configuration

### Custom Sync Policies per Application

To customize sync policies for specific applications, you can:

1. Use label selectors in the template
2. Create multiple ApplicationSets with different selectors
3. Use the List generator with explicit app definitions

### Progressive Rollouts

Enable progressive rollout strategy:

```yaml
spec:
  strategy:
    type: RollingSync
    rollingSync:
      steps:
        - matchExpressions:
            - key: env
              operator: In
              values: [dev]
        - matchExpressions:
            - key: env
              operator: In
              values: [staging]
        - matchExpressions:
            - key: env
              operator: In
              values: [prod]
```

### Multi-Cluster Deployment

Use the Cluster generator to deploy to multiple clusters:

```yaml
generators:
  - matrix:
      generators:
        - git:
            # ... directory generator
        - clusters:
            selector:
              matchLabels:
                environment: production
```

## References

- [ApplicationSet Documentation](https://argo-cd.readthedocs.io/en/stable/operator-manual/applicationset/)
- [Git Generator](https://argo-cd.readthedocs.io/en/stable/operator-manual/applicationset/Generators-Git/)
- [Progressive Sync](https://argo-cd.readthedocs.io/en/stable/operator-manual/applicationset/Progressive-Syncs/)
- [Migration Guide](./MIGRATION.md)
