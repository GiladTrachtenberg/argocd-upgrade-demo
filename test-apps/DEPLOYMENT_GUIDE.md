# ApplicationSet Deployment Guide

Quick start guide for deploying the modernized ApplicationSet-based test applications.

## Prerequisites

- Kubernetes cluster (minikube, kind, or cloud provider)
- Argo CD installed (v2.6 or higher for ApplicationSet support)
- kubectl configured to access your cluster
- argocd CLI installed (optional, for advanced operations)

Check Argo CD version:
```bash
kubectl get deployment argocd-server -n argocd -o jsonpath='{.spec.template.spec.containers[0].image}'
```

## Quick Deploy

### Option 1: Deploy Everything at Once (Recommended)

```bash
kubectl apply -k /Users/giladtrachtenberg/work/scripts/argocd/upgrade/test-apps/
```

This deploys:
- AppProject (test-apps)
- ApplicationSet (test-apps)
- The ApplicationSet will auto-generate Applications

### Option 2: Deploy Step-by-Step

```bash
# 1. Deploy the AppProject first
kubectl apply -f /Users/giladtrachtenberg/work/scripts/argocd/upgrade/test-apps/project.yaml

# 2. Deploy the ApplicationSet
kubectl apply -f /Users/giladtrachtenberg/work/scripts/argocd/upgrade/test-apps/applicationset.yaml

# 3. Wait for Applications to be generated
kubectl get applications -n argocd -w
```

## Verification

### 1. Check ApplicationSet Status

```bash
# View ApplicationSet
kubectl get applicationset -n argocd

# Expected output:
# NAME        AGE
# test-apps   1m
```

### 2. List Generated Applications

```bash
# List all Applications managed by the ApplicationSet
kubectl get applications -n argocd -l demo.managed-by=applicationset

# Expected output:
# NAME                    SYNC STATUS   HEALTH STATUS
# test-guestbook         Synced        Healthy
# test-helm-guestbook    Synced        Healthy
# test-kustomize-...     Synced        Healthy
```

### 3. Check Application Details

```bash
# Describe ApplicationSet to see details
kubectl describe applicationset test-apps -n argocd

# Check a specific Application
kubectl describe application test-guestbook -n argocd
```

### 4. Verify Deployed Resources

```bash
# List all namespaces created by the ApplicationSet
kubectl get namespaces | grep test-

# Check resources in a specific namespace
kubectl get all -n test-guestbook
```

### 5. Run Validation Script

```bash
# Run the automated validation script
/Users/giladtrachtenberg/work/scripts/argocd/upgrade/test-apps/validate-applicationset.sh
```

## Access Applications

### Via Argo CD UI

1. Port-forward to Argo CD UI:
```bash
kubectl port-forward svc/argocd-server -n argocd 8080:443
```

2. Open browser: https://localhost:8080

3. Login:
```bash
# Get admin password
kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" | base64 -d
```

4. View Applications in the UI

### Via Argo CD CLI

```bash
# Login to Argo CD
argocd login localhost:8080

# List applications
argocd app list

# Get specific application details
argocd app get test-guestbook

# View application logs
argocd app logs test-guestbook
```

## Common Operations

### Sync All Applications

```bash
# Sync all Applications managed by ApplicationSet
argocd app sync -l demo.managed-by=applicationset

# Or sync individually
argocd app sync test-guestbook
```

### Force Refresh

```bash
# Force ApplicationSet to re-generate Applications
kubectl annotate applicationset test-apps -n argocd argocd.argoproj.io/refresh=hard --overwrite

# Force Application to sync
argocd app sync test-guestbook --force
```

### View ApplicationSet Controller Logs

```bash
# Tail logs
kubectl logs -n argocd -l app.kubernetes.io/name=argocd-applicationset-controller -f

# View recent logs
kubectl logs -n argocd -l app.kubernetes.io/name=argocd-applicationset-controller --tail=100
```

### Delete Specific Application

```bash
# Delete Application (it will be regenerated by ApplicationSet)
kubectl delete application test-guestbook -n argocd

# To permanently remove, exclude from ApplicationSet or delete ApplicationSet
```

## Troubleshooting

### ApplicationSet Not Creating Applications

**Problem:** ApplicationSet exists but no Applications generated

**Solutions:**
```bash
# 1. Check ApplicationSet status
kubectl describe applicationset test-apps -n argocd

# 2. Check for errors in conditions
kubectl get applicationset test-apps -n argocd -o yaml | grep -A 10 conditions

# 3. Check controller logs
kubectl logs -n argocd -l app.kubernetes.io/name=argocd-applicationset-controller --tail=50

# 4. Verify Git repository is accessible
kubectl run -it --rm debug --image=alpine --restart=Never -- sh -c "apk add git && git ls-remote https://github.com/argoproj/argocd-example-apps.git"
```

### Applications Stuck in OutOfSync

**Problem:** Applications show as OutOfSync

**Solutions:**
```bash
# 1. Check Application sync status
kubectl describe application test-guestbook -n argocd

# 2. Force sync
argocd app sync test-guestbook --force

# 3. Check for sync errors
argocd app get test-guestbook

# 4. Enable auto-sync if disabled
kubectl patch application test-guestbook -n argocd --type=merge -p '{"spec":{"syncPolicy":{"automated":{"prune":true,"selfHeal":true}}}}'
```

### Applications in Degraded Health

**Problem:** Application health shows as Degraded

**Solutions:**
```bash
# 1. Check Application health details
argocd app get test-guestbook

# 2. Check pod status in target namespace
kubectl get pods -n test-guestbook

# 3. Check pod logs
kubectl logs -n test-guestbook -l app=guestbook

# 4. Describe problematic resources
kubectl describe pod <pod-name> -n test-guestbook
```

### ApplicationSet Version Issues

**Problem:** ApplicationSet not supported (Argo CD < v2.6)

**Solutions:**
```bash
# 1. Check Argo CD version
argocd version

# 2. Upgrade Argo CD to v2.6 or higher
# Follow upgrade guide at: https://argo-cd.readthedocs.io/en/stable/operator-manual/upgrading/

# 3. Or rollback to app-of-apps pattern
kubectl apply -f /Users/giladtrachtenberg/work/scripts/argocd/upgrade/test-apps/app-of-apps/application.yaml.deprecated
```

## Cleanup

### Remove All Applications (Keep ApplicationSet)

```bash
# Delete all generated Applications
kubectl delete applications -n argocd -l demo.managed-by=applicationset

# They will be regenerated automatically by ApplicationSet
```

### Remove ApplicationSet and All Applications

```bash
# Delete ApplicationSet (cascades to Applications)
kubectl delete applicationset test-apps -n argocd

# Verify Applications are deleted
kubectl get applications -n argocd
```

### Complete Cleanup

```bash
# Delete everything including project
kubectl delete -k /Users/giladtrachtenberg/work/scripts/argocd/upgrade/test-apps/

# Or delete individually
kubectl delete applicationset test-apps -n argocd
kubectl delete appproject test-apps -n argocd

# Clean up namespaces
kubectl delete namespace test-guestbook test-helm-guestbook test-kustomize-guestbook
```

## Monitoring

### Watch Application Status

```bash
# Watch all Applications
watch kubectl get applications -n argocd

# Watch specific Application
watch kubectl get application test-guestbook -n argocd

# Watch ApplicationSet
watch kubectl get applicationset test-apps -n argocd
```

### Get Application Metrics

```bash
# Count total Applications
kubectl get applications -n argocd -l demo.managed-by=applicationset --no-headers | wc -l

# Count by sync status
kubectl get applications -n argocd -l demo.managed-by=applicationset -o jsonpath='{range .items[*]}{.status.sync.status}{"\n"}{end}' | sort | uniq -c

# Count by health status
kubectl get applications -n argocd -l demo.managed-by=applicationset -o jsonpath='{range .items[*]}{.status.health.status}{"\n"}{end}' | sort | uniq -c
```

## Migration from App-of-Apps

If you still have the old app-of-apps running:

### Step 1: Deploy ApplicationSet (coexist)
```bash
kubectl apply -f /Users/giladtrachtenberg/work/scripts/argocd/upgrade/test-apps/applicationset.yaml
```

### Step 2: Verify ApplicationSet Works
```bash
kubectl get applications -n argocd -l demo.managed-by=applicationset
```

### Step 3: Remove Old App-of-Apps
```bash
kubectl delete application app-of-apps -n argocd
kubectl delete application guestbook -n argocd
kubectl delete application helm-nginx -n argocd
kubectl delete application plain-yaml -n argocd
```

### Step 4: Verify Migration
```bash
/Users/giladtrachtenberg/work/scripts/argocd/upgrade/test-apps/validate-applicationset.sh
```

## Best Practices

1. **Always use labels** to identify Applications managed by ApplicationSet
2. **Monitor ApplicationSet controller** logs during initial deployment
3. **Test in development** environment before production
4. **Keep ApplicationSet simple** - start with basic generators
5. **Document customizations** in ApplicationSet annotations
6. **Use version control** for all ApplicationSet manifests
7. **Implement progressive rollouts** for production environments
8. **Set resource limits** on ApplicationSet controller
9. **Monitor Application count** to prevent over-provisioning
10. **Regular cleanup** of unused Applications and namespaces

## Performance Tips

- Use `excludes` in Git directory generator to skip unnecessary directories
- Set `requeueAfterSeconds` to reduce reconciliation frequency
- Use label selectors to filter Applications
- Enable `preserveResourcesOnDeletion` only when needed
- Implement health check timeouts appropriately
- Use namespace-scoped ApplicationSets when possible

## Security Considerations

- AppProject restricts what ApplicationSet can deploy
- Use RBAC to control ApplicationSet access
- Validate source repositories before adding
- Monitor for unauthorized Application creation
- Audit ApplicationSet modifications
- Use signed commits in Git repositories
- Implement network policies for deployed applications

## Next Steps

1. Explore advanced generators (List, Cluster, Matrix)
2. Implement progressive rollout strategies
3. Add PR environment automation
4. Set up monitoring and alerting
5. Configure webhooks for faster sync
6. Implement GitOps workflows
7. Add custom health checks
8. Configure SSO for Argo CD

## Resources

- ApplicationSet Documentation: https://argo-cd.readthedocs.io/en/stable/operator-manual/applicationset/
- Git Generator: https://argo-cd.readthedocs.io/en/stable/operator-manual/applicationset/Generators-Git/
- Progressive Sync: https://argo-cd.readthedocs.io/en/stable/operator-manual/applicationset/Progressive-Syncs/
- Best Practices: https://argo-cd.readthedocs.io/en/stable/user-guide/best_practices/

## Support

For issues or questions:
1. Check ApplicationSet controller logs
2. Review Argo CD documentation
3. Consult migration guide: `/Users/giladtrachtenberg/work/scripts/argocd/upgrade/test-apps/MIGRATION.md`
4. Run validation script: `/Users/giladtrachtenberg/work/scripts/argocd/upgrade/test-apps/validate-applicationset.sh`
